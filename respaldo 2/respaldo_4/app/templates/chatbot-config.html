{% extends "base.html" %}

{% block content %}
<div class="flex h-screen bg-gray-100">
    <!-- Sidebar -->
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm z-10">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">Configuraci√≥n del Chatbot</h1>
                <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-500">ID: ...</span>
                </div>
            </div>
        </header>

        <!-- Content Scrollable Area -->
        <main class="flex-1 overflow-y-auto p-6">
            <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">

                <!-- Left Column: Configuration -->
                <div class="space-y-6">

                    <!-- General Settings -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-800">Configuraci√≥n General</h2>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="isActive" class="sr-only peer">
                                <div
                                    class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                </div>
                                <span class="ml-3 text-sm font-medium text-gray-700">Activar Chatbot</span>
                            </label>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Mensaje de
                                    Bienvenida</label>
                                <textarea id="welcomeMessage" rows="2"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    placeholder="Hola, ¬øen qu√© puedo ayudarte hoy?"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Prompt del Sistema
                                    (Instrucciones)</label>
                                <textarea id="systemPrompt" rows="4"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    placeholder="Eres un asistente experto en..."></textarea>
                                <p class="mt-1 text-xs text-gray-500">Define la personalidad y el rol del chatbot.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Base de Conocimiento (Texto
                                    Directo)</label>
                                <textarea id="knowledgeBase" rows="4"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    placeholder="Informaci√≥n clave que el bot debe saber..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Documents Upload -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Documentos de Referencia</h2>

                        <div id="uploadZone"
                            class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors cursor-pointer bg-gray-50">
                            <input type="file" id="fileInput" multiple class="hidden" accept=".pdf,.txt,.doc,.docx">
                            <div class="text-4xl mb-2">üìÑ</div>
                            <p class="text-sm text-gray-600 font-medium">Arrastra archivos aqu√≠ o haz clic para subir
                            </p>
                            <p class="text-xs text-gray-400 mt-1">PDF, TXT, DOC (Max 10MB)</p>
                        </div>

                        <!-- Upload Progress -->
                        <div id="uploadProgress" class="hidden mt-4">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="progressFill" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <p id="progressText" class="text-xs text-gray-500 mt-1 text-right">0%</p>
                        </div>

                        <!-- Documents List -->
                        <div class="mt-6">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Documentos Cargados (<span
                                    id="docCount">0</span>)</h3>
                            <div id="documentsList" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                                <!-- Doc Items will be injected here -->
                                <div id="noDocuments" class="text-center text-gray-400 py-4 text-sm">No hay documentos
                                    cargados</div>
                            </div>
                        </div>
                    </div>

                    <!-- URL Management -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">Fuentes Web (URLs)</h2>

                        <div class="bg-gray-50 p-4 rounded-md mb-4 border border-gray-200">
                            <div class="space-y-3">
                                <input type="url" id="urlInput" placeholder="https://ejemplo.com/articulo"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                                <div class="grid grid-cols-2 gap-3">
                                    <input type="text" id="specialtyInput" placeholder="Especialidad (opcional)"
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                                    <input type="text" id="descriptionInput" placeholder="Descripci√≥n breve"
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                                </div>
                                <button id="btnAddUrl"
                                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition text-sm font-medium flex justify-center items-center gap-2">
                                    <span>‚ûï</span> Agregar URL
                                </button>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">URLs Indexadas (<span
                                    id="urlCount">0</span>)</h3>
                            <div id="urlsList" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                                <!-- URL Items will be injected here -->
                                <div id="noUrls" class="text-center text-gray-400 py-4 text-sm">No hay URLs agregadas
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Right Column: Test Chatbot -->
                <div class="flex flex-col h-[calc(100vh-140px)] sticky top-6">
                    <div class="bg-white rounded-lg shadow-lg flex flex-col h-full border border-gray-200">
                        <!-- Chat Header -->
                        <div
                            class="p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg flex justify-between items-center">
                            <div>
                                <h2 class="text-lg font-bold text-gray-800">Probar Chatbot</h2>
                                <p class="text-xs text-gray-500">Prueba la configuraci√≥n en tiempo real</p>
                            </div>
                            <button onclick="saveConfig()"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition flex items-center gap-2 shadow-sm">
                                <span>üíæ</span> Guardar Todo
                            </button>
                        </div>

                        <!-- Chat Messages Area -->
                        <div id="testChatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-white">
                            <div class="text-center py-8">
                                <div class="bg-blue-50 text-blue-800 px-4 py-3 rounded-lg inline-block text-sm">
                                    üëã ¬°Hola! Configura tu chatbot y pru√©balo aqu√≠.
                                    <br>Recuerda <strong>guardar los cambios</strong> antes de probar.
                                </div>
                            </div>
                        </div>

                        <!-- Chat Input Area -->
                        <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                            <div class="flex gap-2">
                                <div class="flex-1 relative">
                                    <input type="text" id="testChatInput"
                                        class="w-full pl-4 pr-10 py-3 rounded-xl border-gray-300 focus:border-blue-500 focus:ring-blue-500 shadow-sm"
                                        placeholder="Escribe un mensaje..."
                                        onkeypress="if(event.key==='Enter') sendTestMessage()">
                                </div>
                                <button onclick="sendTestMessage()"
                                    class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl transition shadow-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                    </svg>
                                </button>
                                <button onclick="startVoiceRecognition()" id="micBtn"
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 p-3 rounded-xl transition"
                                    title="Hablar">
                                    üé§
                                </button>
                                <button onclick="toggleContinuousMode()" id="continuousBtn"
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 p-3 rounded-xl transition"
                                    title="Modo Conversaci√≥n Continua">
                                    ‚ôí
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>
</div>

<style>
    /* Custom Scrollbar for lists */
    #documentsList::-webkit-scrollbar,
    #urlsList::-webkit-scrollbar,
    #testChatMessages::-webkit-scrollbar {
        width: 6px;
    }

    #documentsList::-webkit-scrollbar-track,
    #urlsList::-webkit-scrollbar-track,
    #testChatMessages::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    #documentsList::-webkit-scrollbar-thumb,
    #urlsList::-webkit-scrollbar-thumb,
    #testChatMessages::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    #documentsList::-webkit-scrollbar-thumb:hover,
    #urlsList::-webkit-scrollbar-thumb:hover,
    #testChatMessages::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .drag-over {
        border-color: #2563eb !important;
        background-color: #eff6ff !important;
    }
</style>

<script>
    let professionalId = null;

    // DOM Elements
    const fileInput = document.getElementById('fileInput');
    const uploadZone = document.getElementById('uploadZone');
    const documentsList = document.getElementById('documentsList');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const docCount = document.getElementById('docCount');
    const noDocuments = document.getElementById('noDocuments');

    const urlInput = document.getElementById('urlInput');
    const specialtyInput = document.getElementById('specialtyInput');
    const descriptionInput = document.getElementById('descriptionInput');
    const btnAddUrl = document.getElementById('btnAddUrl');
    const urlsList = document.getElementById('urlsList');
    const noUrls = document.getElementById('noUrls');
    const urlCount = document.getElementById('urlCount');

    const chatMessages = document.getElementById('testChatMessages');
    const chatInput = document.getElementById('testChatInput');

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        if (!requireRole('professional')) return;

        await loadProfessionalId();

        if (professionalId) {
            loadConfig();
            loadDocuments();
            loadUrls();
            setupUploadEvents();
            setupUrlEvents();
        }
    });

    async function loadProfessionalId() {
        try {
            const user = getCurrentUser();
            if (!user) return;

            const response = await fetch(`/api/profesionales?user_id=${user.id}`, {
                headers: { 'Authorization': `Bearer ${getAuthToken()}` }
            });
            const data = await response.json();

            if (data.success && data.data.professionals && data.data.professionals.length > 0) {
                professionalId = data.data.professionals[0].id;
                // Update UI
                const idDisplay = document.querySelector('header span.text-gray-500');
                if (idDisplay) idDisplay.textContent = `ID: ${professionalId}`;
            } else {
                showToast('No se encontr√≥ perfil profesional asociado', 'error');
            }
        } catch (e) {
            console.error("Error loading professional ID:", e);
            showToast('Error al cargar perfil profesional', 'error');
        }
    }

    // --- Configuration ---
    function loadConfig() {
        if (!professionalId) return;
        fetch(`/api/chatbot/${professionalId}/config`, {
            headers: { 'Authorization': `Bearer ${getAuthToken()}` }
        })
            .then(r => r.json())
            .then(data => {
                if (data.success && data.data) {
                    const config = data.data;
                    if (document.getElementById('isActive')) document.getElementById('isActive').checked = config.is_active;
                    if (document.getElementById('welcomeMessage')) document.getElementById('welcomeMessage').value = config.welcome_message || '';
                    if (document.getElementById('systemPrompt')) document.getElementById('systemPrompt').value = config.system_prompt || '';
                    if (document.getElementById('knowledgeBase')) document.getElementById('knowledgeBase').value = config.knowledge_base || '';
                }
            });
    }

    function saveConfig() {
        if (!professionalId) return;
        const data = {
            is_active: document.getElementById('isActive').checked,
            welcome_message: document.getElementById('welcomeMessage').value,
            system_prompt: document.getElementById('systemPrompt').value,
            knowledge_base: document.getElementById('knowledgeBase').value
        };

        fetch(`/api/chatbot/${professionalId}/config`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify(data)
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) showToast('Configuraci√≥n guardada correctamente', 'success');
                else showToast('Error al guardar configuraci√≥n', 'error');
            })
            .catch(() => showToast('Error de conexi√≥n al guardar', 'error'));
    }

    // --- Documents ---
    function setupUploadEvents() {
        if (!uploadZone) return;

        uploadZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });
    }

    function handleFiles(files) {
        if (!files.length || !professionalId) return;

        const formData = new FormData();
        Array.from(files).forEach(file => formData.append('file', file)); // Changed 'files' to 'file' as per backend expectation

        uploadProgress.classList.remove('hidden');

        // Simulated progress
        let progress = 0;
        const interval = setInterval(() => {
            progress += 10;
            if (progress > 90) clearInterval(interval);
            updateProgress(progress);
        }, 200);

        // Use correct endpoint for document upload
        fetch(`/api/chatbot/${professionalId}/knowledge-base/upload`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${getAuthToken()}` },
            body: formData
        })
            .then(r => r.json())
            .then(data => {
                clearInterval(interval);
                updateProgress(100);
                setTimeout(() => {
                    uploadProgress.classList.add('hidden');
                    updateProgress(0);
                }, 1000);

                if (data.success) {
                    showToast('Documento subido exitosamente', 'success');
                    loadDocuments();
                } else {
                    showToast(data.error || 'Error al subir documento', 'error');
                }
            })
            .catch(err => {
                clearInterval(interval);
                uploadProgress.classList.add('hidden');
                showToast('Error de conexi√≥n al subir', 'error');
            });
    }

    function updateProgress(percent) {
        progressFill.style.width = `${percent}%`;
        progressText.textContent = `${percent}%`;
    }

    function loadDocuments() {
        if (!professionalId) return;
        // Use correct endpoint for listing documents
        fetch(`/api/chatbot/${professionalId}/knowledge-base/documents`, {
            headers: { 'Authorization': `Bearer ${getAuthToken()}` }
        })
            .then(r => r.json())
            .then(data => {
                const docs = data.data.documents || [];
                documentsList.innerHTML = '';
                docCount.textContent = docs.length;

                if (docs.length === 0) {
                    noDocuments.style.display = 'block';
                } else {
                    noDocuments.style.display = 'none';
                    docs.forEach(doc => {
                        const html = `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <span class="text-xl">üìÑ</span>
                                <div class="min-w-0">
                                    <p class="text-sm font-medium text-gray-800 truncate">${doc.filename}</p>
                                    <p class="text-xs text-gray-500">${doc.size_formatted} ‚Ä¢ ${new Date(doc.uploaded_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <button onclick="deleteDocument(${doc.id})" class="text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50 transition" title="Eliminar">
                                üóëÔ∏è
                            </button>
                        </div>
                    `;
                        documentsList.insertAdjacentHTML('beforeend', html);
                    });
                }
            });
    }

    function deleteDocument(docId) {
        if (!confirm('¬øEst√°s seguro de eliminar este documento?')) return;

        // Use correct endpoint for deleting document
        fetch(`/api/chatbot/${professionalId}/knowledge-base/documents/${docId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${getAuthToken()}` }
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('Documento eliminado', 'success');
                    loadDocuments();
                } else {
                    showToast('Error al eliminar documento', 'error');
                }
            });
    }

    // --- URLs ---
    function setupUrlEvents() {
        if (btnAddUrl) btnAddUrl.addEventListener('click', addUrl);
    }

    function addUrl(e) {
        if (e) e.preventDefault();
        if (!professionalId) return;

        const url = urlInput.value.trim();
        const specialty = specialtyInput.value.trim();
        const description = descriptionInput.value.trim();

        if (!url) {
            showToast('Por favor ingresa una URL v√°lida', 'warning');
            return;
        }

        btnAddUrl.disabled = true;
        btnAddUrl.innerHTML = '<span class="animate-spin">‚åõ</span> Agregando...';

        const payload = { url, specialty, description };

        fetch(`/api/profesionales/${professionalId}/urls`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify(payload)
        })
            .then(r => r.json())
            .then(data => {
                btnAddUrl.disabled = false;
                btnAddUrl.innerHTML = '<span>‚ûï</span> Agregar URL';

                if (data.success) {
                    urlInput.value = '';
                    specialtyInput.value = '';
                    descriptionInput.value = '';
                    loadUrls();
                    showToast('URL agregada exitosamente', 'success');
                } else {
                    showToast(data.error || 'Error al agregar URL', 'error');
                }
            })
            .catch(err => {
                btnAddUrl.disabled = false;
                btnAddUrl.innerHTML = '<span>‚ûï</span> Agregar URL';
                showToast('Error de conexi√≥n', 'error');
            });
    }

    function loadUrls() {
        if (!professionalId) return;

        fetch(`/api/profesionales/${professionalId}/urls`, {
            headers: { 'Authorization': `Bearer ${getAuthToken()}` }
        })
            .then(r => r.json())
            .then(data => {
                const urls = data.data.urls || [];
                urlsList.innerHTML = '';

                if (urls.length === 0) {
                    noUrls.style.display = 'block';
                    urlCount.textContent = '0';
                } else {
                    noUrls.style.display = 'none';
                    urlCount.textContent = urls.length;
                    urls.forEach(url => addUrlUI(url));
                }
            })
            .catch(e => console.error("Error loading URLs:", e));
    }

    function addUrlUI(url) {
        const date = new Date(url.created_at).toLocaleDateString('es-ES');
        const fetched = url.last_fetched ? new Date(url.last_fetched).toLocaleString('es-ES') : 'Pendiente';

        const html = `
        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition">
            <div class="flex justify-between items-start">
                <div class="flex-1 min-w-0 mr-2">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-lg">üåê</span>
                        <a href="${url.url}" target="_blank" class="text-blue-600 hover:underline text-sm font-medium truncate block">${url.url}</a>
                    </div>
                    <div class="flex flex-wrap gap-2 text-xs text-gray-500 mb-1">
                        <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">${url.specialty || 'General'}</span>
                        <span>Agregado: ${date}</span>
                    </div>
                    <div class="text-xs text-gray-400">Consultado: ${fetched}</div>
                    ${url.description ? (() => {
                const div = document.createElement('div');
                div.textContent = url.description;
                return `<div class="text-xs text-gray-600 mt-1 italic border-l-2 border-gray-300 pl-2">${div.innerHTML}</div>`;
            })() : ''}
                </div>
                <div class="flex flex-col gap-1">
                    <button onclick="refreshUrl(${url.id})" class="text-blue-500 hover:text-blue-700 p-1 rounded hover:bg-blue-50" title="Actualizar contenido">üîÑ</button>
                    <button onclick="deleteUrl(${url.id})" class="text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50" title="Eliminar">üóëÔ∏è</button>
                </div>
            </div>
        </div>
        `;
        urlsList.insertAdjacentHTML('beforeend', html);
    }

    window.deleteUrl = function (urlId) {
        if (!professionalId) return;
        if (!confirm('¬øEliminar esta URL?')) return;

        fetch(`/api/profesionales/${professionalId}/urls/${urlId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${getAuthToken()}` }
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    loadUrls();
                    showToast('URL eliminada', 'success');
                }
                else showToast('Error al eliminar URL', 'error');
            });
    };

    window.refreshUrl = function (urlId) {
        if (!professionalId) return;

        fetch(`/api/profesionales/${professionalId}/urls/${urlId}/refresh`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${getAuthToken()}` }
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    showToast('Contenido actualizado correctamente', 'success');
                    loadUrls();
                } else {
                    showToast(data.error || 'Error al actualizar', 'error');
                }
            });
    };

    // --- Test Chat ---
    async function sendTestMessage() {
        const text = chatInput.value.trim();
        if (!text) return;

        appendMessage(text, 'user');
        chatInput.value = '';

        const typingId = appendMessage('Escribiendo...', 'bot', true);

        try {
            // Use correct endpoint for chat
            const response = await fetch(`/api/chatbot/${professionalId}/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({
                    message: text,
                    professional_id: professionalId
                })
            });

            const data = await response.json();
            document.getElementById(typingId).remove();

            if (data.success) {
                appendMessage(data.response, 'bot');
            } else {
                appendMessage('Error: ' + (data.error || 'No se pudo obtener respuesta'), 'error');
            }
        } catch (e) {
            if (document.getElementById(typingId)) document.getElementById(typingId).remove();
            appendMessage('Error de conexi√≥n', 'error');
        }
    }

    function appendMessage(text, type, isTyping = false) {
        const id = 'msg-' + Date.now();
        const div = document.createElement('div');
        div.id = id;
        div.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;

        const bubble = document.createElement('div');
        bubble.className = `max-w-[85%] rounded-2xl px-4 py-2 shadow-sm ${type === 'user'
            ? 'bg-blue-600 text-white rounded-br-none'
            : type === 'error'
                ? 'bg-red-100 text-red-600'
                : 'bg-white border border-gray-200 text-gray-800 rounded-bl-none'
            }`;

        if (isTyping) {
            bubble.innerHTML = '<span class="animate-pulse">...</span>';
            bubble.classList.add('italic', 'text-gray-500');
        } else {
            bubble.textContent = text;
        }

        div.appendChild(bubble);
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        return id;
    }

    // Auth Helper
    function getAuthToken() {
        return localStorage.getItem('token') || '';
    }

    // Toast Helper (Simple implementation if components.js is missing or fails)
    function showToast(message, type = 'info') {
        if (window.showToastComponent) {
            window.showToastComponent(message, type);
            return;
        }
        // Fallback
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 transition-opacity duration-300 ${type === 'success' ? 'bg-green-600' :
            type === 'error' ? 'bg-red-600' : 'bg-blue-600'
            }`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>
{% endblock %}