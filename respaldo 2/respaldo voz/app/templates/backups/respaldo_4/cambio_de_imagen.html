<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cambio de Imagen IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f0f2f5;
            min-height: 100vh;
            font-family: sans-serif;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
    </style>
</head>

<body class="py-10 px-4">

    <main class="w-full max-w-6xl mx-auto space-y-8">

        <!-- Header -->
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/" class="bg-white p-3 rounded-full shadow-md hover:scale-105 transition-transform text-2xl">
                    ‚¨ÖÔ∏è
                </a>
                <div>
                    <h1 class="text-4xl font-bold text-slate-800">Cambio de Imagen IA</h1>
                    <p class="text-slate-500">Transforma tu estilo con Inteligencia Artificial</p>
                </div>
            </div>
            <div class="bg-blue-100 text-blue-700 px-4 py-2 rounded-full font-bold text-sm">
                ‚ú® Beta Preview
            </div>
        </div>

        <!-- Main Workspace -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Left Panel: Input (Original) -->
            <div class="bg-white rounded-[30px] p-6 shadow-xl flex flex-col h-full relative overflow-hidden group">
                <h2 class="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <span>üë§</span> Tu Foto Actual
                </h2>

                <!-- Upload Area -->
                <div id="uploadArea"
                    class="flex-1 border-4 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 hover:border-blue-400 transition-all relative overflow-hidden"
                    onclick="document.getElementById('fileInput').click()">

                    <!-- Placeholder Content -->
                    <div id="uploadPlaceholder" class="text-center p-8">
                        <span class="text-6xl mb-4 block opacity-50">üì§</span>
                        <p class="text-slate-500 font-medium">Sube una foto de cuerpo completo</p>
                        <p class="text-slate-400 text-sm mt-2">o arrastra aqu√≠</p>
                    </div>

                    <!-- Image Preview -->
                    <img id="originalPreview" class="hidden absolute inset-0 w-full h-full object-cover">

                    <!-- Change Photo Button (Visible on Hover when image exists) -->
                    <div id="changePhotoOverlay"
                        class="hidden absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="bg-white text-slate-800 px-6 py-2 rounded-full font-bold shadow-lg">Cambiar
                            Foto</span>
                    </div>
                </div>

                <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="handleImageUpload(event)">

                <!-- Quick Access Gallery -->
                <div class="mt-6 border-t border-slate-100 pt-4">
                    <h3 class="text-sm font-bold text-slate-500 mb-3 flex items-center justify-between">
                        <span>‚ö° Acceso R√°pido</span>
                        <span class="text-xs font-normal bg-slate-100 px-2 py-1 rounded-full">√öltimas 5</span>
                    </h3>
                    <div id="quickAccessGallery" class="grid grid-cols-5 gap-2">
                        <!-- Gallery items injected by JS -->
                    </div>
                </div>
            </div>

            <!-- Right Panel: Output (Transformation) -->
            <div class="bg-white rounded-[30px] p-6 shadow-xl flex flex-col h-full relative">
                <h2 class="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <span>‚ú®</span> Resultado IA
                </h2>

                <!-- Result Area -->
                <div id="resultArea"
                    class="flex-1 bg-slate-100 rounded-2xl flex items-center justify-center relative overflow-hidden">

                    <!-- Empty State -->
                    <div id="resultPlaceholder" class="text-center p-8 opacity-50">
                        <span class="text-6xl mb-4 block">üîÆ</span>
                        <p class="text-slate-500 font-medium">El resultado aparecer√° aqu√≠</p>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState"
                        class="hidden absolute inset-0 bg-white/90 flex flex-col items-center justify-center z-20">
                        <div class="animate-spin text-4xl mb-4">üåÄ</div>
                        <p class="text-blue-600 font-bold animate-pulse">Generando nuevo estilo...</p>
                    </div>

                    <!-- Result Image -->
                    <img id="resultImage" class="hidden absolute inset-0 w-full h-full object-cover z-10">
                </div>
            </div>

        </div>

        <!-- Controls Panel -->
        <div class="bg-white rounded-[30px] p-8 shadow-xl">

            <!-- Mode Selection -->
            <div class="flex items-center justify-center gap-6 mb-8 border-b border-slate-100 pb-8">
                <label class="flex items-center gap-3 cursor-pointer group">
                    <input type="radio" name="mode" value="style" checked onchange="toggleMode('style')"
                        class="w-6 h-6 text-blue-600 focus:ring-blue-500">
                    <span class="text-lg font-bold text-slate-700 group-hover:text-blue-600 transition-colors">üé® Look
                        Completo IA</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer group">
                    <input type="radio" name="mode" value="tryon" onchange="toggleMode('tryon')"
                        class="w-6 h-6 text-blue-600 focus:ring-blue-500">
                    <span class="text-lg font-bold text-slate-700 group-hover:text-blue-600 transition-colors">üõçÔ∏è
                        Probador Virtual</span>
                </label>
            </div>

            <!-- Section: Style Selection (Default) -->
            <div id="styleSection">
                <h3 class="text-xl font-bold text-slate-800 mb-6">Selecciona un Estilo</h3>

                <div id="styleSlotsContainer" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                    <!-- Slots injected by JS -->
                </div>
            </div>

            <!-- Section: Virtual Try-On (Hidden by default) -->
            <div id="tryonSection" class="hidden">
                <h3 class="text-xl font-bold text-slate-800 mb-6">üõçÔ∏è Personaliza tu Look con el Closet IA</h3>

                <div id="inventorySelectors" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Selectors injected by JS -->
                    <div
                        class="col-span-full text-center py-8 text-slate-400 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                        Cargando tu closet...
                    </div>
                </div>
            </div>

            <button id="btnGenerate" onclick="generateTransformation()" disabled
                class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold text-xl shadow-lg hover:bg-slate-900 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3">
                <span>ü™Ñ</span> Generar Transformaci√≥n
            </button>
        </div>

    </main>

    <script>
        let currentImage = null;
        let selectedStyleIndex = 0; // Default to first slot
        let currentMode = 'style'; // 'style' or 'tryon'
        let selectedItems = {}; // { 'Jeans': {id: 123, img: '...'}, ... }
        const MAX_HISTORY = 5;

        // Default Style Slots Configuration
        const DEFAULT_STYLES = [
            { name: "Diario C√≥modo", icon: "üõãÔ∏è", vibe: "VIBE_RELAXED" },
            { name: "Oficina Formal", icon: "üíº", vibe: "VIBE_PROFESSIONAL" },
            { name: "Evento de Noche", icon: "üç∑", vibe: "VIBE_SEDUCTIVE" },
            { name: "Fiesta Elegante", icon: "ü•Ç", vibe: "VIBE_FESTIVE" },
            { name: "Cl√°sico Retro", icon: "üéûÔ∏è", vibe: "VIBE_VINTAGE" },
            { name: "Look de Gala", icon: "‚ú®", vibe: "VIBE_LUXURY" }
        ];

        let styleSlots = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadGallery();
            initStyleSlots();
        });

        // --- STYLE SLOTS LOGIC (Interface 2.0) ---
        function initStyleSlots() {
            // Load from localStorage or use defaults
            const saved = localStorage.getItem('styleSlots');
            if (saved) {
                styleSlots = JSON.parse(saved);
            } else {
                styleSlots = JSON.parse(JSON.stringify(DEFAULT_STYLES)); // Deep copy
            }
            renderStyleSlots();
        }

        function renderStyleSlots() {
            const container = document.getElementById('styleSlotsContainer');
            container.innerHTML = '';

            styleSlots.forEach((slot, index) => {
                const isSelected = index === selectedStyleIndex;

                const btn = document.createElement('div');
                // Base classes
                let classes = "relative p-4 rounded-2xl border-2 transition-all flex flex-col items-center gap-2 group cursor-pointer select-none ";

                // State classes
                if (isSelected) {
                    classes += "border-blue-500 bg-blue-50 shadow-md transform scale-105 ";
                } else {
                    classes += "border-slate-200 bg-white hover:border-blue-300 hover:bg-slate-50 ";
                }

                btn.className = classes;

                // Click handler: Select on click, Edit on double click (or long press logic could be added)
                btn.onclick = () => handleSlotClick(index);

                btn.innerHTML = `
                    <span class="text-3xl mb-1">${slot.icon}</span>
                    <div id="slot-name-${index}" class="font-bold text-slate-700 text-center text-sm w-full truncate">
                        ${slot.name}
                    </div>
                    <input id="slot-input-${index}" type="text" value="${slot.name}" 
                        class="hidden w-full text-center text-sm font-bold border-b-2 border-blue-500 outline-none bg-transparent"
                        onblur="saveSlotEdit(${index})" onkeypress="handleInputKey(event, ${index})"
                        onclick="event.stopPropagation()">
                    
                    <!-- Edit Indicator (only visible on hover) -->
                    <span class="absolute top-2 right-2 text-xs opacity-0 group-hover:opacity-50">‚úèÔ∏è</span>
                `;

                container.appendChild(btn);
            });
        }

        function handleSlotClick(index) {
            if (selectedStyleIndex === index) {
                // Already selected -> Enter Edit Mode
                enterEditMode(index);
            } else {
                // Select
                selectedStyleIndex = index;
                renderStyleSlots();
            }
        }

        function enterEditMode(index) {
            const nameDiv = document.getElementById(`slot-name-${index}`);
            const input = document.getElementById(`slot-input-${index}`);

            if (nameDiv && input) {
                nameDiv.classList.add('hidden');
                input.classList.remove('hidden');
                input.focus();
                input.select();
            }
        }

        function saveSlotEdit(index) {
            const input = document.getElementById(`slot-input-${index}`);
            if (input) {
                const newName = input.value.trim();
                if (newName) {
                    styleSlots[index].name = newName;
                    localStorage.setItem('styleSlots', JSON.stringify(styleSlots));
                }
            }
            // Re-render to exit edit mode and show updated state
            renderStyleSlots();
        }

        function handleInputKey(event, index) {
            if (event.key === 'Enter') {
                saveSlotEdit(index);
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = e.target.result;
                    setMainImage(imageData);
                    saveToGallery(imageData);
                };
                reader.readAsDataURL(file);
            }
        }

        function setMainImage(imageData) {
            currentImage = imageData;

            // Show Preview
            const img = document.getElementById('originalPreview');
            img.src = currentImage;
            img.classList.remove('hidden');

            // Hide Placeholder
            document.getElementById('uploadPlaceholder').classList.add('hidden');
            document.getElementById('changePhotoOverlay').classList.remove('hidden');

            // Enable Generate Button
            document.getElementById('btnGenerate').disabled = false;
        }

        // --- GALLERY LOGIC ---
        function saveToGallery(imageData) {
            let history = JSON.parse(localStorage.getItem('imgHistory') || '[]');

            // Avoid duplicates at the top
            if (history.length > 0 && history[0] === imageData) return;

            // Add new image to top
            history.unshift(imageData);

            // Limit to MAX_HISTORY
            if (history.length > MAX_HISTORY) {
                history = history.slice(0, MAX_HISTORY);
            }

            localStorage.setItem('imgHistory', JSON.stringify(history));
            loadGallery();
        }

        function loadGallery() {
            const gallery = document.getElementById('quickAccessGallery');
            const history = JSON.parse(localStorage.getItem('imgHistory') || '[]');

            gallery.innerHTML = '';

            if (history.length === 0) {
                gallery.innerHTML = `<p class="col-span-5 text-xs text-slate-400 text-center py-2">Sin historial reciente</p>`;
                return;
            }

            history.forEach((imgData, index) => {
                const div = document.createElement('div');
                div.className = "relative group aspect-square rounded-lg overflow-hidden cursor-pointer border border-slate-200 hover:border-blue-400 transition-all";
                div.onclick = () => setMainImage(imgData);

                div.innerHTML = `
                    <img src="${imgData}" class="w-full h-full object-cover">
                    <button onclick="deleteFromGallery(event, ${index})" 
                        class="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 rounded-bl-lg">
                        √ó
                    </button>
                `;
                gallery.appendChild(div);
            });
        }

        function deleteFromGallery(event, index) {
            event.stopPropagation();
            let history = JSON.parse(localStorage.getItem('imgHistory') || '[]');
            history.splice(index, 1);
            localStorage.setItem('imgHistory', JSON.stringify(history));
            loadGallery();
        }

        // --- TRY-ON LOGIC ---
        function toggleMode(mode) {
            currentMode = mode;
            const styleSec = document.getElementById('styleSection');
            const tryonSec = document.getElementById('tryonSection');
            const btn = document.getElementById('btnGenerate');

            if (mode === 'style') {
                styleSec.classList.remove('hidden');
                tryonSec.classList.add('hidden');
                btn.innerHTML = "<span>ü™Ñ</span> Generar Transformaci√≥n";
            } else {
                styleSec.classList.add('hidden');
                tryonSec.classList.remove('hidden');
                btn.innerHTML = "<span>üõçÔ∏è</span> Probar Prendas Seleccionadas";
                loadInventorySelectors();
            }
        }

        function loadInventorySelectors() {
            const container = document.getElementById('inventorySelectors');
            const inventory = JSON.parse(localStorage.getItem('inventario_ia') || '[]');

            // Group by category
            const categories = {};
            inventory.forEach(item => {
                if (!categories[item.categoria]) categories[item.categoria] = [];
                categories[item.categoria].push(item);
            });

            const targetCategories = ["Blusa", "Jeans", "Vestido", "Zapatos", "Abrigo", "Accesorios"];

            container.innerHTML = '';

            targetCategories.forEach(cat => {
                const items = categories[cat] || [];

                const div = document.createElement('div');
                div.className = "bg-slate-50 p-4 rounded-xl border border-slate-200";

                let optionsHtml = `<option value="">(Ninguno)</option>`;
                items.forEach(item => {
                    optionsHtml += `<option value="${item.id}">ID: ${item.id.toString().slice(-4)}</option>`;
                });

                div.innerHTML = `
                    <label class="block text-sm font-bold text-slate-700 mb-2">${cat}</label>
                    <div class="flex gap-3">
                        <div id="preview-${cat}" class="w-16 h-16 bg-white rounded-lg border border-slate-200 flex items-center justify-center overflow-hidden">
                            <span class="text-2xl opacity-20">üëï</span>
                        </div>
                        <select onchange="selectItem('${cat}', this.value)" class="flex-1 rounded-lg border-slate-300 text-sm">
                            ${optionsHtml}
                        </select>
                    </div>
                `;
                container.appendChild(div);
            });

            if (inventory.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8 bg-yellow-50 rounded-2xl border border-yellow-100 text-yellow-700">
                        <p class="font-bold">‚ö†Ô∏è Tu closet est√° vac√≠o</p>
                        <p class="text-sm mt-1">Ve a "Mi Closet" para agregar y clasificar ropa primero.</p>
                        <a href="/closet" class="inline-block mt-3 text-blue-600 underline text-sm">Ir al Closet</a>
                    </div>
                `;
            }
        }

        function selectItem(category, id) {
            const inventory = JSON.parse(localStorage.getItem('inventario_ia') || '[]');
            const item = inventory.find(i => i.id == id);
            const preview = document.getElementById(`preview-${category}`);

            if (item) {
                selectedItems[category] = item;
                preview.innerHTML = `<img src="${item.imagen_base64}" class="w-full h-full object-cover">`;
            } else {
                delete selectedItems[category];
                preview.innerHTML = `<span class="text-2xl opacity-20">üëï</span>`;
            }
        }

        async function generateTransformation() {
            if (!currentImage) {
                alert("Por favor sube una foto primero");
                return;
            }

            // Collect selected items
            const itemsToTryOn = [];
            for (const category in selectedItems) {
                if (selectedItems[category]) {
                    itemsToTryOn.push(selectedItems[category]);
                }
            }

            // Check mode
            if (currentMode === 'tryon' && itemsToTryOn.length === 0) {
                alert("Por favor selecciona al menos una prenda del inventario.");
                return;
            }

            const loading = document.getElementById('loadingState');
            const resultImg = document.getElementById('resultImage');
            const placeholder = document.getElementById('resultPlaceholder');
            const btn = document.getElementById('btnGenerate');

            // Start Loading
            loading.classList.remove('hidden');
            placeholder.classList.add('hidden');
            resultImg.classList.add('hidden');
            btn.disabled = true;
            btn.textContent = "‚è≥ Procesando con Sastre Virtual...";

            try {
                // If mode is style, we might want to keep simulation or implement another endpoint
                // For now, let's focus on the 'tryon' mode which uses the new API
                if (currentMode === 'tryon') {
                    const response = await fetch('/api/virtual-try-on', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            person_image: currentImage,
                            items: itemsToTryOn
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        resultImg.src = result.image;
                        resultImg.classList.remove('hidden');
                        loading.classList.add('hidden');

                        console.log("Transformation Description:", result.description);
                        console.log("Metadata:", result.metadata);
                        alert("¬°Transformaci√≥n completada! La imagen incluye metadatos del Sastre Virtual.");
                    } else {
                        alert("Error: " + result.error);
                        // Revert UI on error
                        loading.classList.add('hidden');
                        placeholder.classList.remove('hidden');
                    }
                } else {
                    // Style mode simulation with Semantic Retrieval
                    const currentSlot = styleSlots[selectedStyleIndex];
                    console.log(`[SEMANTIC SEARCH] Searching for items with vibe: ${currentSlot.vibe} (${currentSlot.name})`);

                    setTimeout(() => {
                        resultImg.src = currentImage;
                        resultImg.style.filter = getFilterForStyle(currentSlot.vibe); // Use vibe for filter logic
                        alert(`¬°Transformaci√≥n '${currentSlot.name}' completada!\n\n(Simulaci√≥n: Se buscaron prendas con etiqueta ${currentSlot.vibe})`);
                        loading.classList.add('hidden');
                        resultImg.classList.remove('hidden');
                    }, 2000);
                }

            } catch (error) {
                console.error("Error calling Virtual Tailor:", error);
                alert("Error de conexi√≥n con el Sastre Virtual.");
                loading.classList.add('hidden');
                placeholder.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = "<span>ü™Ñ</span> Generar Otra Vez";
            }
        }

        function getFilterForStyle(vibe) {
            // Map VIBE to filters for simulation
            switch (vibe) {
                case 'VIBE_RELAXED': return 'contrast(1.1) saturate(1.2)';
                case 'VIBE_PROFESSIONAL': return 'grayscale(0.2) contrast(1.2)';
                case 'VIBE_SEDUCTIVE': return 'brightness(0.9) contrast(1.3) saturate(1.1)'; // Darker, moody
                case 'VIBE_FESTIVE': return 'saturate(1.5) contrast(1.1)'; // Vibrant
                case 'VIBE_VINTAGE': return 'sepia(0.4) contrast(0.9)';
                case 'VIBE_LUXURY': return 'brightness(1.1) saturate(1.3) sepia(0.1)'; // Golden glow
                default: return 'none';
            }
        }
    </script>
</body>

</html>