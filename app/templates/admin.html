<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - CompletMirror.io</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/locations.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="/static/css/style.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-serif {
            font-family: 'Playfair Display', serif;
        }

        /* Tab Transitions */
        .tab-content {
            transition: opacity 0.2s ease-in-out;
        }
    </style>
</head>

<body class="bg-[#FAFAFA] flex h-screen overflow-hidden text-slate-800">
    <aside class="w-64 bg-white border-r h-full flex flex-col hidden md:flex">
        <div class="p-6 border-b flex items-center gap-2">
            <i data-lucide="sparkles" class="h-6 w-6 text-blue-600"></i>
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                CompletMirror.io</h1>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <a href="/dashboard-profesional"
                class="flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-blue-50 hover:text-blue-600 rounded-xl transition group">
                <span class="text-xl group-hover:scale-110 transition-transform">üìä</span>
                <span class="font-medium">Dashboard</span>
            </a>

            <!-- Mis Finanzas Section -->
            <div class="mt-4 mb-2 px-4 text-xs font-bold text-slate-400 uppercase">Mis Finanzas</div>
            <a href="/mis-finanzas"
                class="flex items-center gap-3 px-4 py-2 text-slate-600 hover:bg-blue-50 hover:text-blue-600 rounded-xl transition group">
                <span class="text-lg">üè†</span>
                <span class="font-medium">Inicio</span>
            </a>
            <a href="/mis-finanzas/ingresos"
                class="flex items-center gap-3 px-4 py-2 text-slate-600 hover:bg-emerald-50 hover:text-emerald-600 rounded-xl transition group">
                <span class="text-lg">üí∞</span>
                <span class="font-medium">Bancos</span>
            </a>
            <a href="/mis-finanzas/facturas"
                class="flex items-center gap-3 px-4 py-2 text-slate-600 hover:bg-rose-50 hover:text-rose-600 rounded-xl transition group">
                <span class="text-lg">üßæ</span>
                <span class="font-medium">Gastos</span>
            </a>
            <a href="/mis-finanzas/pagos"
                class="flex items-center gap-3 px-4 py-2 text-slate-600 hover:bg-orange-50 hover:text-orange-600 rounded-xl transition group">
                <span class="text-lg">üí≥</span>
                <span class="font-medium">Pagos</span>
            </a>
            <a href="/mis-finanzas/pendientes"
                class="flex items-center gap-3 px-4 py-2 text-slate-600 hover:bg-yellow-50 hover:text-yellow-600 rounded-xl transition group">
                <span class="text-lg">‚è≥</span>
                <span class="font-medium">Pendientes</span>
            </a>
            <a href="/mis-finanzas/reportes"
                class="flex items-center gap-3 px-4 py-2 text-slate-600 hover:bg-purple-50 hover:text-purple-600 rounded-xl transition group">
                <span class="text-lg">üìà</span>
                <span class="font-medium">Reportes</span>
            </a>

            <div class="border-t border-slate-100 my-2 pt-2">
                <p class="px-4 text-xs font-bold text-slate-400 uppercase mb-2">Herramientas</p>
                <a href="/cambio_de_imagen"
                    class="flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-pink-50 hover:text-pink-600 rounded-xl transition group">
                    <span class="text-xl group-hover:scale-110 transition-transform">üé®</span>
                    <span class="font-medium">Cambio de Imagen</span>
                </a>
                <a href="/closet"
                    class="flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-purple-50 hover:text-purple-600 rounded-xl transition group">
                    <span class="text-xl group-hover:scale-110 transition-transform">üëó</span>
                    <span class="font-medium">Mi Closet IA</span>
                </a>
                <a href="/mirror"
                    class="flex items-center gap-3 px-4 py-3 text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-xl transition group">
                    <span class="text-xl group-hover:scale-110 transition-transform">ü™û</span>
                    <span class="font-medium">Mirror IA</span>
                </a>
            </div>
        </nav>
        <div class="px-4 py-3 border-t bg-slate-50 flex flex-col gap-2">
            <!-- User Identity Payload -->
            <div id="sidebarUserIdentity"
                class="flex items-center gap-3 px-2 py-2 mb-1 rounded-lg bg-white border border-slate-100 shadow-sm">
                <div
                    class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-sm">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p id="sidebarUserName" class="text-sm font-bold text-slate-700 truncate">Usuario</p>
                    <p id="sidebarUserEmail" class="text-xs text-slate-400 truncate">...</p>
                </div>
            </div>

            <button onclick="logout()"
                class="w-full px-4 py-2 text-red-600 hover:bg-red-100 rounded-xl transition flex items-center justify-center gap-2 font-medium text-sm">
                <span>üö™</span> Cerrar Sesi√≥n
            </button>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // 1. Populate User Info
                const userStr = localStorage.getItem('asesoriaimss_user');
                if (userStr) {
                    const user = JSON.parse(userStr);
                    const nameEl = document.getElementById('sidebarUserName');
                    const emailEl = document.getElementById('sidebarUserEmail');

                    if (nameEl) nameEl.textContent = user.full_name || 'Usuario';
                    if (emailEl) emailEl.textContent = user.email || '';
                }
            });
            function logout() {
                localStorage.removeItem('asesoriaimss_token');
                localStorage.removeItem('asesoriaimss_user');
                window.location.href = '/login';
            }
        </script>
    </aside>

    <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
        <main class="flex-1 overflow-y-auto p-6 md:p-12 scroll-smooth">
            <div class="max-w-7xl mx-auto space-y-8 animate-fade-in">

                <!-- Header -->
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h1 class="font-serif text-3xl text-gray-900 font-bold mb-2">Panel de Administraci√≥n</h1>
                        <p class="text-gray-500">Gesti√≥n global de la plataforma.</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="adminName" class="text-gray-700 font-medium"></span>
                    </div>
                </div>

                <!-- Stats Dashboard -->
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <div onclick="switchTab('users'); document.getElementById('userRoleFilter').value='all'; loadUsers();"
                        class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-all cursor-pointer group">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2">Total Usuarios
                                </p>
                                <p id="statUsers"
                                    class="text-3xl font-serif font-bold text-blue-600 group-hover:scale-105 transition-transform origin-left">
                                    0</p>
                            </div>
                            <div
                                class="h-12 w-12 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center">
                                <i data-lucide="users" class="h-6 w-6"></i>
                            </div>
                        </div>
                    </div>
                    <div onclick="switchTab('users'); document.getElementById('userRoleFilter').value='professional'; loadUsers();"
                        class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-all cursor-pointer group">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2">Profesionales
                                </p>
                                <p id="statProfessionals"
                                    class="text-3xl font-serif font-bold text-emerald-600 group-hover:scale-105 transition-transform origin-left">
                                    0</p>
                            </div>
                            <div
                                class="h-12 w-12 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center">
                                <i data-lucide="star" class="h-6 w-6"></i>
                            </div>
                        </div>
                    </div>
                    <div onclick="switchTab('validations')"
                        class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-all cursor-pointer group">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2">Validaciones
                                </p>
                                <p id="statPending"
                                    class="text-3xl font-serif font-bold text-amber-500 group-hover:scale-105 transition-transform origin-left">
                                    0</p>
                            </div>
                            <div
                                class="h-12 w-12 bg-amber-50 text-amber-500 rounded-full flex items-center justify-center">
                                <i data-lucide="check-circle" class="h-6 w-6"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2">Ingresos</p>
                                <p id="statRevenue" class="text-3xl font-serif font-bold text-purple-600">$0</p>
                            </div>
                            <div
                                class="h-12 w-12 bg-purple-50 text-purple-500 rounded-full flex items-center justify-center">
                                <i data-lucide="dollar-sign" class="h-6 w-6"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs Navigation -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-8">
                    <div class="flex overflow-x-auto custom-scrollbar">
                        <button id="tabUsers" onclick="switchTab('users')"
                            class="tab-btn px-6 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-50 border-b-2 border-transparent transition-all whitespace-nowrap">
                            Usuarios
                        </button>
                        <button id="tabSalons" onclick="switchTab('salons')"
                            class="tab-btn px-6 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-50 border-b-2 border-transparent transition-all whitespace-nowrap">
                            Salones
                        </button>
                        <button id="tabShops" onclick="switchTab('shops')"
                            class="tab-btn px-6 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-50 border-b-2 border-transparent transition-all whitespace-nowrap">
                            Tiendas
                        </button>
                        <button id="tabComments" onclick="switchTab('comments')"
                            class="tab-btn px-6 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-50 border-b-2 border-transparent transition-all whitespace-nowrap">
                            Comentarios
                        </button>
                        <button id="tabCredits" onclick="switchTab('credits')"
                            class="tab-btn px-6 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-50 border-b-2 border-transparent transition-all whitespace-nowrap">
                            Agregar Cr√©ditos
                        </button>
                        <button id="tabValidations" onclick="switchTab('validations')"
                            class="tab-btn px-6 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-50 border-b-2 border-transparent transition-all whitespace-nowrap">
                            Validaciones
                        </button>
                        <button id="tabSpecialties" onclick="switchTab('specialties')"
                            class="tab-btn px-6 py-4 text-sm font-semibold text-gray-600 hover:bg-gray-50 border-b-2 border-transparent transition-all whitespace-nowrap">
                            Especialidades
                        </button>
                    </div>
                </div>

                <!-- Tab Contents -->
                <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-8 min-h-[400px]">

                    <!-- Users Tab -->
                    <div id="usersTab" class="tab-content">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="font-serif text-2xl font-bold text-gray-900">Gesti√≥n de Usuarios</h2>
                            <div class="flex gap-3">
                                <select id="userRoleFilter" onchange="loadUsers()"
                                    class="px-4 py-2 rounded-xl border border-gray-200 outline-none focus:border-blue-500 text-sm">
                                    <option value="all">Todos los Roles</option>
                                    <option value="user">Usuarios</option>
                                    <option value="professional">Profesionales</option>
                                    <option value="admin">Administradores</option>
                                </select>
                                <button onclick="loadUsers()"
                                    class="p-2 text-gray-400 hover:text-blue-600 transition-colors rounded-full hover:bg-blue-50">
                                    <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="border-b border-gray-100">
                                        <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">
                                            Usuario</th>
                                        <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Rol
                                        </th>
                                        <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Estado
                                        </th>
                                        <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Quota
                                        </th>
                                        <th
                                            class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider text-right">
                                            Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody" class="text-sm text-gray-600">
                                    <!-- Rows injected via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Salons Tab (New) -->
                    <div id="salonsTab" class="tab-content hidden">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="font-serif text-2xl font-bold text-gray-900">Salones Registrados</h2>
                            <button onclick="openSalonModal()"
                                class="bg-blue-600 text-white px-6 py-2 rounded-xl text-sm font-semibold hover:bg-blue-700 transition shadow-lg shadow-blue-200">
                                + Nuevo Sal√≥n
                            </button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="border-b border-gray-100">
                                        <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Sal√≥n
                                        </th>
                                        <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">
                                            Cliente</th>
                                        <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Estado
                                        </th>
                                        <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Fechas
                                        </th>
                                        <th class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Tokens
                                        </th>
                                        <th
                                            class="pb-4 text-xs font-bold text-gray-400 uppercase tracking-wider text-right">
                                            Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="salonsTableBody" class="text-sm text-gray-600">
                                    <!-- Injected -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Add Salon Modal -->
                    <div id="salonModal"
                        class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
                        <div class="bg-white rounded-3xl p-8 max-w-lg w-full mx-4 shadow-2xl animate-fade-in relative">
                            <button onclick="closeSalonModal()"
                                class="absolute top-6 right-6 text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="h-6 w-6"></i>
                            </button>
                            <h3 class="font-serif text-2xl font-bold text-gray-900 mb-6">Nuevo Sal√≥n</h3>
                            <form id="salonForm" class="space-y-4">
                                <div>
                                    <label
                                        class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Email
                                        o Tel√©fono del Cliente</label>
                                    <div class="flex gap-2">
                                        <select id="salonPhoneCode"
                                            class="w-1/3 px-3 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none bg-gray-50 text-sm">
                                            <!-- Injected by JS -->
                                            <option value="+52">üá≤üáΩ (+52)</option>
                                        </select>
                                        <input type="text" id="salonClientIdentifier" required
                                            placeholder="email@ejemplo.com √≥ 5512345678"
                                            class="w-2/3 px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none">
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Si es tel√©fono, selecciona la lada correcta.
                                    </p>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Nombre
                                        del Cliente (Responsable)</label>
                                    <input type="text" id="salonClientName" required placeholder="Nombre Completo"
                                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none">
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Nombre
                                        del Sal√≥n</label>
                                    <input type="text" id="salonName" required placeholder="Ej. Studio Elegance"
                                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none">
                                </div>
                                <div>
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Direcci√≥n
                                            (Calle y N√∫mero)</label>
                                        <textarea id="salonAddress" required rows="2"
                                            placeholder="Calle, N√∫mero, Colonia..."
                                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none"></textarea>
                                    </div>
                                    <div class="grid grid-cols-3 gap-3">
                                        <div>
                                            <label
                                                class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Pa√≠s</label>
                                            <select id="salonCountry" required data-target-state="salonState"
                                                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none">
                                                <option value="">Cargando...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label
                                                class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Estado</label>
                                            <select id="salonState" required disabled data-target-city="salonCity"
                                                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none bg-gray-50">
                                                <option value="">Selecciona Pa√≠s</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label
                                                class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Ciudad</label>
                                            <select id="salonCity" required disabled
                                                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none bg-gray-50">
                                                <option value="">Selecciona Estado</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label
                                                class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Inicio
                                                Operaciones</label>
                                            <input type="date" id="salonStartDate" required
                                                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none">
                                        </div>
                                        <div>
                                            <label
                                                class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Fecha
                                                de Cobro</label>
                                            <input type="date" id="salonPaymentDate" required
                                                class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none">
                                        </div>
                                    </div>
                                    <div>
                                        <label
                                            class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Tokens
                                            Inciales (Consumidos)</label>
                                        <input type="number" id="salonTokens" value="0" min="0"
                                            class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none">
                                    </div>
                                    <button type="submit"
                                        class="w-full py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition font-bold shadow-lg shadow-blue-200 mt-4">
                                        Crear Sal√≥n
                                    </button>
                            </form>
                        </div>
                    </div>

                    <!-- Shops Tab (New) -->
                    <div id="shopsTab" class="tab-content hidden">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="font-serif text-2xl font-bold text-gray-900">Tiendas Asociadas</h2>
                            <button
                                class="bg-blue-600 text-white px-6 py-2 rounded-xl text-sm font-semibold hover:bg-blue-700 transition shadow-lg shadow-blue-200">
                                + Agregar Tienda
                            </button>
                        </div>
                        <div class="text-center py-20 bg-gray-50 rounded-2xl border border-dashed border-gray-200">
                            <div
                                class="bg-white w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                                <i data-lucide="shopping-bag" class="h-8 w-8 text-gray-300"></i>
                            </div>
                            <h3 class="text-gray-900 font-medium mb-1">Gesti√≥n de Tiendas</h3>
                            <p class="text-gray-500 text-sm">Administraci√≥n de tiendas de ropa, productos y proveedores.
                            </p>
                        </div>
                    </div>

                    <!-- Comments Tab -->
                    <div id="commentsTab" class="tab-content hidden">
                        <h2 class="font-serif text-2xl font-bold text-gray-900 mb-6">Comentarios Pendientes</h2>
                        <div id="commentsContainer" class="space-y-4">
                            <!-- Injected -->
                        </div>
                    </div>

                    <!-- Credits Tab -->
                    <div id="creditsTab" class="tab-content hidden">
                        <h2 class="font-serif text-2xl font-bold text-gray-900 mb-6">Agregar Cr√©ditos Manualmente</h2>

                        <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-8 flex items-start gap-3">
                            <i data-lucide="info" class="h-5 w-5 text-amber-600 mt-0.5"></i>
                            <div>
                                <p class="text-amber-800 font-semibold text-sm">¬øBuscas validar compras?</p>
                                <p class="text-amber-700 text-xs">Si necesitas aprobar compras de cr√©ditos hechas por
                                    usuarios, ve a la pesta√±a de <a href="#"
                                        onclick="event.preventDefault(); switchTab('validations')"
                                        class="underline hover:text-amber-900">Validaciones</a>.</p>
                            </div>
                        </div>

                        <div class="max-w-xl mx-auto bg-gray-50 p-8 rounded-3xl border border-gray-100">
                            <!-- Search -->
                            <div class="mb-6 relative">
                                <label
                                    class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Buscar
                                    Profesional</label>
                                <div class="relative">
                                    <i data-lucide="search" class="absolute left-4 top-3 h-5 w-5 text-gray-400"></i>
                                    <input type="text" id="searchProfessional" placeholder="Nombre o email..."
                                        class="w-full pl-11 pr-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none transition-all">
                                </div>
                                <div id="searchResults"
                                    class="absolute z-10 w-full bg-white border border-gray-100 rounded-xl shadow-xl mt-2 hidden max-h-60 overflow-y-auto">
                                </div>
                            </div>

                            <form id="creditsForm" class="space-y-4">
                                <div>
                                    <label
                                        class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">ID
                                        Usuario</label>
                                    <input type="number" id="professionalId" required readonly
                                        class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-white text-gray-500">
                                    <p id="selectedProfessionalName"
                                        class="text-sm text-blue-600 font-medium mt-2 ml-1"></p>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Cantidad</label>
                                    <input type="number" id="creditAmount" required min="1"
                                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none transition-all">
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Motivo</label>
                                    <textarea id="creditReason" rows="2"
                                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none transition-all"></textarea>
                                </div>
                                <button type="submit"
                                    class="w-full py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition font-bold shadow-lg shadow-blue-200 mt-4">
                                    Procesar Recarga
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Validations Tab (Renamed from Transactions) -->
                    <div id="validationsTab" class="tab-content hidden">
                        <div class="grid md:grid-cols-2 gap-8">
                            <!-- Pending Credits -->
                            <div>
                                <h2 class="font-serif text-2xl font-bold text-gray-900 mb-6">Recargas Pendientes</h2>
                                <div id="transactionsContainer" class="space-y-4">
                                    <!-- Injected -->
                                </div>
                            </div>
                            <!-- Pending Withdrawals (Placeholder for now, can be implemented) -->
                            <div>
                                <h2 class="font-serif text-2xl font-bold text-gray-900 mb-6 font-serif">Retiros
                                    Pendientes</h2>
                                <div id="withdrawalsContainer" class="space-y-4">
                                    <p class="text-center text-gray-400 py-12">No hay retiros pendientes.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Specialties Tab -->
                    <div id="specialtiesTab" class="tab-content hidden">
                        <h2 class="font-serif text-2xl font-bold text-gray-900 mb-6">Especialidades</h2>
                        <div class="flex gap-4 mb-8">
                            <input type="text" id="newSpecialtyInput" placeholder="Nombre de especialidad..."
                                class="flex-1 px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 outline-none">
                            <button onclick="addSpecialtyWrapper()"
                                class="bg-emerald-500 text-white px-6 py-2 rounded-xl hover:bg-emerald-600 transition font-bold shadow-lg shadow-emerald-200">
                                Agregar
                            </button>
                        </div>
                        <div id="specialtiesList" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <!-- Injected -->
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script src="/static/js/auth.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/components.js"></script>

    <script>
        lucide.createIcons();

        // Check Auth
        document.addEventListener('DOMContentLoaded', async () => {
            // Simple client-side check, robust verification happens in API calls
            const user = getCurrentUser();
            if (!user || user.role !== 'admin') {
                // Redirecting... in a real app logic
                // window.location.href = '/login'; 
            }
            if (user) document.getElementById('adminName').textContent = user.full_name;

            // Initial Load
            await loadDashboard();
            switchTab('users'); // Default tab
            loadUsers();
        });

        // Tab Switching Logic
        function switchTab(tabName) {
            // Hide all tabs
            const tabs = ['users', 'salons', 'shops', 'comments', 'credits', 'validations', 'specialties'];
            tabs.forEach(t => {
                const el = document.getElementById(t + 'Tab');
                if (el) el.classList.add('hidden');

                const btn = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
                if (btn) {
                    btn.classList.remove('border-blue-600', 'text-blue-600', 'bg-blue-50');
                    btn.classList.add('border-transparent', 'text-gray-600');
                }
            });

            // Show selected
            const targetEl = document.getElementById(tabName + 'Tab');
            if (targetEl) targetEl.classList.remove('hidden');

            const targetBtn = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (targetBtn) {
                targetBtn.classList.add('border-blue-600', 'text-blue-600', 'bg-blue-50');
                targetBtn.classList.remove('border-transparent', 'text-gray-600');
            }

            // Lazy Load Data
            if (tabName === 'comments') loadPendingComments();
            if (tabName === 'validations') {
                loadPendingTransactions();
                // loadPendingWithdrawals(); // Future TODO
            }
            if (tabName === 'specialties') loadSpecialties();
            if (tabName === 'salons') loadSalons();
        }

        // --- SALONS LOGIC ---
        function openSalonModal() { document.getElementById('salonModal').classList.remove('hidden'); }
        function closeSalonModal() { document.getElementById('salonModal').classList.add('hidden'); }

        async function loadSalons() {
            const tbody = document.getElementById('salonsTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-400">Cargando salones...</td></tr>';

            const res = await apiGet('/admin/salones');
            if (res.success && res.data.salons.length > 0) {
                tbody.innerHTML = res.data.salons.map(s => `
                    <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                        <td class="py-4 font-medium">
                            <div class="flex flex-col">
                                <span class="text-gray-900">${s.salon_name}</span>
                                <span class="text-xs text-gray-500 max-w-[200px] truncate" title="${s.address}, ${s.city}, ${s.state}">
                                    ${s.address}<br>
                                    ${s.city}, ${s.state}, ${s.country}
                                </span>
                            </div>
                        </td>
                        <td class="py-4">
                             <div class="flex flex-col">
                                <span class="text-gray-900 text-sm">${s.client_name}</span>
                                <span class="text-xs text-blue-500">${s.client_email}</span>
                            </div>
                        </td>
                        <td class="py-4 text-xs text-gray-500">
                             <p>Inicio: ${s.start_date || '-'}</p>
                             <p>Cobro: ${s.payment_date || '-'}</p>
                        </td>
                        <td class="py-4 text-sm">
                            <span class="font-bold text-gray-700">${s.user_tokens_used || 0}</span>
                            <span class="text-gray-400">/ ${s.user_tokens_limit || '‚àû'}</span>
                        </td>
                        <td class="py-4 text-right">
                             <button onclick="deleteSalon(${s.id})" class="text-rose-400 hover:text-rose-600 transition p-2"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                        </td>
                    </tr>
                `).join('');
                lucide.createIcons();
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-400">No hay salones registrados.</td></tr>';
            }
        }

        // Initialize Dropdowns
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof populateCountries === 'function') {
                populateCountries('salonCountry');
                populatePhoneCodes('salonPhoneCode');

                // Event Listeners for cascading
                document.getElementById('salonCountry').addEventListener('change', function () {
                    loadStatesForCountry(this.value, this.dataset.targetState);
                });
                document.getElementById('salonState').addEventListener('change', function () {
                    loadCitiesForState(document.getElementById('salonCountry').value, this.value, this.dataset.targetCity);
                });
            }
        });

        document.getElementById('salonForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Handle Client Identifier (Email or Phone)
            let identifier = document.getElementById('salonClientIdentifier').value.trim();
            const phoneCode = document.getElementById('salonPhoneCode').value;

            // Simple heuristic: if it looks like a phone number (digits only or mostly digits), prepend code
            // If it has '@', treat as email and ignore code
            if (!identifier.includes('@') && /^\d+$/.test(identifier.replace(/\s/g, ''))) {
                identifier = phoneCode + identifier.replace(/\D/g, ''); // e.g. +525512345678
            }

            const data = {
                client_identifier: identifier,
                client_name: document.getElementById('salonClientName').value,
                salon_name: document.getElementById('salonName').value,
                address: document.getElementById('salonAddress').value,
                city: document.getElementById('salonCity').value,
                state: document.getElementById('salonState').value,
                country: document.getElementById('salonCountry').value,
                start_date: document.getElementById('salonStartDate').value,
                payment_date: document.getElementById('salonPaymentDate').value,
                tokens_consumed: document.getElementById('salonTokens').value
            };

            const res = await apiPost('/admin/salones', data);
            if (res.success) {
                alert('Sal√≥n creado exitosamente');
                closeSalonModal();
                e.target.reset();
                // Reset dropdowns
                populateCountries('salonCountry');
                loadSalons();
            } else {
                alert('Error: ' + res.error);
            }
        });

        async function deleteSalon(id) {
            if (confirm('¬øSeguro que desea eliminar este sal√≥n?')) {
                const res = await apiDelete(`/admin/salones/${id}`);
                if (res.success) loadSalons();
                else alert(res.error);
            }
        }


        // --- Data Loading Functions ---

        async function loadDashboard() {
            const result = await getAdminDashboard();
            if (result.success) {
                document.getElementById('statUsers').textContent = result.data.users?.total || 0;
                // Assuming API returns 'professionals' count separate or filtered
                document.getElementById('statProfessionals').textContent = result.data.users?.professionals_count || result.data.professionals?.total || 0;

                const pending = (result.data.pending?.comments || 0) + (result.data.pending?.payments || 0) + (result.data.pending?.withdrawals || 0);
                document.getElementById('statPending').textContent = pending;
                document.getElementById('statRevenue').textContent = formatCurrency(result.data.revenue?.total_mxn || 0);
            }
        }

        async function loadUsers() {
            const role = document.getElementById('userRoleFilter').value;
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-400">Cargando...</td></tr>';

            try {
                // Determine API endpoint filter based on local logic or backend support
                // For now assuming the backend filter logic supports 'role' param or we filter client side if needed
                const result = await apiGet(`/admin/usuarios?role=${role === 'all' ? '' : role}`);

                if (result.success && result.data.users) {
                    if (result.data.users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-gray-400">No se encontraron usuarios.</td></tr>';
                        return;
                    }

                    tbody.innerHTML = result.data.users.map(u => {
                        const statusColor = u.subscription_status === 'active' ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-500';
                        return `
                        <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                            <td class="py-4 font-medium">
                                <div class="flex flex-col">
                                    <span class="text-gray-900">${u.full_name}</span>
                                    <span class="text-xs text-gray-500">${u.email}</span>
                                </div>
                            </td>
                            <td class="py-4">
                                <span class="px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-xs font-bold capitalize">${u.role}</span>
                            </td>
                            <td class="py-4">
                                <span class="px-3 py-1 rounded-full text-xs font-bold capitalize ${statusColor}">
                                    ${u.subscription_status || 'Inactivo'}
                                </span>
                            </td>
                            <td class="py-4 text-xs font-mono">
                                <span class="text-gray-900 font-bold">${u.current_month_tokens || 0}</span>
                                <span class="text-gray-400"> / ${u.monthly_token_limit}</span>
                            </td>
                            <td class="py-4 text-right">
                                <button onclick="toggleUserStatus(${u.id}, '${u.subscription_status === 'active' ? 'inactive' : 'active'}')" 
                                    class="text-xs font-bold text-blue-600 hover:text-blue-800 transition">
                                    ${u.subscription_status === 'active' ? 'Bloquear' : 'Activar'}
                                </button>
                            </td>
                        </tr>
                        `;
                    }).join('');
                }
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-rose-500">Error al cargar usuarios.</td></tr>';
            }
        }

        async function loadPendingComments() {
            const container = document.getElementById('commentsContainer');
            const result = await getPendingComments();

            if (result.success && result.data.comments && result.data.comments.length > 0) {
                container.innerHTML = result.data.comments.map(c => `
                    <div class="bg-white border border-gray-100 rounded-2xl p-6 shadow-sm">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-bold text-gray-900">${c.author_name}</h4>
                                <p class="text-xs text-gray-500">Para: <span class="text-blue-600 font-medium">${c.professional_name}</span></p>
                            </div>
                            <span class="text-xs text-gray-400">${formatDate(c.created_at)}</span>
                        </div>
                        <p class="text-gray-600 text-sm mb-4 bg-gray-50 p-4 rounded-xl">"${c.content}"</p>
                        <div class="flex gap-2 justify-end">
                            <button onclick="approveComment(${c.id})" class="px-4 py-2 bg-emerald-50 text-emerald-600 rounded-xl text-xs font-bold hover:bg-emerald-100 transition">Aprobar</button>
                            <button onclick="rejectComment(${c.id})" class="px-4 py-2 bg-rose-50 text-rose-600 rounded-xl text-xs font-bold hover:bg-rose-100 transition">Rechazar</button>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `<p class="text-center text-gray-400 py-12">No hay comentarios pendientes.</p>`;
            }
        }

        // Reuse approve/reject functions from API logic (Assuming defined in current scope or inline)
        async function approveComment(id) {
            const res = await updateCommentStatus(id, 'approved');
            if (res.success) { loadPendingComments(); loadDashboard(); }
        }
        async function rejectComment(id) {
            const res = await updateCommentStatus(id, 'rejected');
            if (res.success) { loadPendingComments(); loadDashboard(); }
        }

        async function loadPendingTransactions() {
            const container = document.getElementById('transactionsContainer');
            const result = await apiGet('/admin/transacciones'); // Helper from earlier steps potentially

            // Fallback rendering
            if (result.success && result.data.transactions && result.data.transactions.length > 0) {
                container.innerHTML = result.data.transactions.map(tx => `
                    <div class="flex items-center justify-between bg-white border border-gray-100 rounded-2xl p-4 shadow-sm">
                        <div class="flex items-center gap-4">
                            <div class="h-10 w-10 bg-amber-50 text-amber-500 rounded-full flex items-center justify-center">
                                <i data-lucide="clock" class="h-5 w-5"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-900 text-sm">${tx.professional_name}</p>
                                <div class="text-xs text-gray-500 flex flex-col gap-0.5">
                                    <span>${tx.email} &bull; ${tx.phone || 'Sin t√©lefono'}</span>
                                    <span class="font-medium text-blue-600">ID Usuario: ${tx.professional_id}</span>
                                    <span>Compra: ${tx.amount} cr√©ditos ($${tx.price_mxn})</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="approveTransaction(${tx.id})" title="Aprobar" class="p-2 text-emerald-500 hover:bg-emerald-50 rounded-lg transition"><i data-lucide="check" class="h-5 w-5"></i></button>
                             <button onclick="rejectTransaction(${tx.id})" title="Rechazar" class="p-2 text-rose-500 hover:bg-rose-50 rounded-lg transition"><i data-lucide="x" class="h-5 w-5"></i></button>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            } else {
                container.innerHTML = `<p class="text-center text-gray-400 py-12">No hay recargas pendientes.</p>`;
            }
        }

        // Mock approve/reject tx if not globally defined
        async function approveTransaction(id) {
            await apiPost(`/admin/transacciones/${id}/aprobar`);
            loadPendingTransactions();
        }
        async function rejectTransaction(id) {
            await apiPost(`/admin/transacciones/${id}/rechazar`);
            loadPendingTransactions();
        }

        async function loadSpecialties() {
            const container = document.getElementById('specialtiesList');
            const res = await apiGet('/admin/especialidades');

            if (res.success && res.data.specialties) {
                container.innerHTML = res.data.specialties.map(s => `
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl border border-gray-100">
                        <span class="text-sm font-bold text-gray-700">${s.name}</span>
                        <button onclick="deleteSpecialty(${s.id})" class="text-rose-400 hover:text-rose-600 transition"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                    </div>
                 `).join('');
                lucide.createIcons();
            }
        }

        async function addSpecialtyWrapper() {
            const input = document.getElementById('newSpecialtyInput');
            if (input.value.trim()) {
                await apiPost('/admin/especialidades', { name: input.value.trim() });
                input.value = '';
                loadSpecialties();
            }
        }

        async function deleteSpecialty(id) {
            if (confirm('Eliminar especialidad?')) {
                await apiDelete(`/admin/especialidades/${id}`);
                loadSpecialties();
            }
        }

        // Search Professional Logic (Simplified)
        const searchInput = document.getElementById('searchProfessional');
        const searchResults = document.getElementById('searchResults');
        let searchTimeout;

        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value;
                if (query.length < 2) { searchResults.classList.add('hidden'); return; }

                searchTimeout = setTimeout(async () => {
                    const res = await apiGet(`/admin/profesionales/buscar?q=${encodeURIComponent(query)}`);
                    if (res.success && res.data.professionals.length > 0) {
                        searchResults.innerHTML = res.data.professionals.map(p => `
                            <div onclick="selectProfessional(${p.id}, '${p.full_name}')" class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-50 last:border-0 transition-colors">
                                <p class="font-bold text-sm text-gray-900">${p.full_name}</p>
                                <p class="text-xs text-gray-500">${p.email}</p>
                            </div>
                         `).join('');
                        searchResults.classList.remove('hidden');
                    } else {
                        searchResults.innerHTML = '<div class="p-3 text-xs text-gray-400">No encontrado</div>';
                        searchResults.classList.remove('hidden');
                    }
                }, 300);
            });
        }

        function selectProfessional(id, name) {
            document.getElementById('professionalId').value = id;
            document.getElementById('selectedProfessionalName').textContent = name;
            searchResults.classList.add('hidden');
            searchInput.value = '';
        }

        document.getElementById('creditsForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('professionalId').value;
            const amount = document.getElementById('creditAmount').value;
            const reason = document.getElementById('creditReason').value;

            const res = await apiPost(`/admin/creditos/${id}`, { amount, reason });
            if (res.success) {
                alert('Cr√©ditos agregados');
                e.target.reset();
                document.getElementById('selectedProfessionalName').textContent = '';
            } else {
                alert('Error: ' + res.error);
            }
        });

    </script>
</body>

</html>