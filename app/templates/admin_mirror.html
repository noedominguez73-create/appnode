<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Mirror IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0f1016;
            color: #ecf0f1;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1a1b26;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #3d4052;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #4e5166;
        }

        /* Glassmorphism utilities */
        .glass-panel {
            background: rgba(26, 27, 38, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-input {
            background: rgba(15, 16, 22, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }

        .glass-input:focus {
            border-color: #FFD700;
            outline: none;
            background: rgba(15, 16, 22, 0.9);
        }
    </style>
</head>

<body class="min-h-screen p-4 md:p-8 flex justify-center items-start">

    <!-- Top Navigation -->
    <nav class="fixed top-0 left-0 w-full z-50 px-8 py-4 flex justify-between items-center pointer-events-none">
        <div class="pointer-events-auto">
            <!-- Brand or Logo could go here -->
        </div>
        <div class="flex gap-4 pointer-events-auto">
            <a href="/mirror"
                class="bg-white/5 border border-white/10 text-gray-400 hover:text-white hover:bg-white/10 hover:border-white/30 transition rounded-full px-5 py-2 flex items-center gap-2 text-sm font-medium backdrop-blur-md">
                <i class="fas fa-arrow-left"></i> <span class="hidden sm:inline">Volver</span>
            </a>
            <a href="/api/mirror/control-pantalla"
                class="bg-white/5 border border-white/10 text-gray-400 hover:text-[#00ff88] hover:bg-white/10 hover:border-[#00ff88]/30 transition rounded-full px-5 py-2 flex items-center gap-2 text-sm font-medium backdrop-blur-md">
                <i class="fas fa-desktop"></i> <span class="hidden sm:inline">Control Pantalla</span>
            </a>
        </div>
    </nav>

    <main class="w-full max-w-6xl mt-16 space-y-8 pb-20">

        <!-- Header Block -->
        <header class="flex justify-between items-end border-b border-gray-800 pb-6">
            <div>
                <h1
                    class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-[#FFD700] to-[#FFA500]">
                    Mirror Admin
                </h1>
                <p class="text-gray-500 text-sm mt-1">Centro de Mando & Configuración IA</p>
            </div>
            <div class="flex gap-2 text-xs text-gray-600 font-mono">
                <span>v2.1.0</span>
                <span>•</span>
                <span id="connectionStatus" class="text-green-500">Conectado</span>
            </div>
        </header>

        <!-- Stats Section -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <!-- Main KPI -->
            <div class="col-span-1 md:col-span-2 glass-panel rounded-2xl p-6 relative overflow-hidden group">
                <div
                    class="absolute -right-10 -top-10 w-40 h-40 bg-[#FFD700] opacity-5 blur-[80px] rounded-full group-hover:opacity-10 transition duration-700">
                </div>

                <div class="flex justify-between items-start z-10 relative">
                    <div>
                        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">Generaciones Totales
                        </p>
                        <h2 class="text-5xl font-bold text-white" id="statsCount">--</h2>
                    </div>
                    <div class="p-3 bg-[#FFD700]/10 rounded-xl text-[#FFD700]">
                        <i class="fas fa-camera text-2xl"></i>
                    </div>
                </div>

                <div class="mt-6 flex items-center gap-2">
                    <button onclick="fetchStats()"
                        class="text-xs text-[#FFD700] hover:text-white flex items-center gap-1 transition-colors">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                    <span class="text-gray-700 text-xs">|</span>
                    <span class="text-xs text-gray-500" id="totalTokensCount">-- Tokens Consumidos</span>
                </div>
            </div>

            <!-- Upload Quick Action -->
            <div class="col-span-1 md:col-span-2 glass-panel rounded-2xl p-6 border-l-4 border-l-[#00ff88]">
                <h3 class="text-[#00ff88] font-bold text-sm mb-4 flex items-center gap-2">
                    <i class="fas fa-cloud-upload-alt"></i> Subir Nuevo Asset
                </h3>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="text" id="newItemName" placeholder="Nombre..."
                        class="glass-input w-full rounded p-2 text-sm">
                    <select id="newItemCategory" onchange="toggleColorInput()"
                        class="glass-input w-full rounded p-2 text-sm bg-[#0f1016]">
                        <option value="hairstyle">Peinado (Hairstyle)</option>
                        <option value="color">Color (Tinte)</option>
                    </select>
                </div>

                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <input type="file" id="newItemFile" class="hidden" accept="image/*"
                            onchange="updateFileLabel(this)">
                        <label for="newItemFile" id="fileLabel"
                            class="glass-input block w-full rounded p-2 text-xs text-center cursor-pointer hover:bg-white/5 truncate">
                            <i class="fas fa-image mr-1"></i> Seleccionar Imagen
                        </label>
                    </div>
                    <!-- Color Picker (Hidden by default) -->
                    <input type="color" id="newItemColorCode"
                        class="hidden w-10 h-full rounded cursor-pointer p-0 border-none bg-transparent"
                        title="Código de Color">

                    <button onclick="uploadItem()" id="uploadBtn"
                        class="bg-[#00ff88] hover:bg-[#00cc6a] text-black font-bold text-xs px-4 rounded transition shadow-lg shadow-green-900/20">
                        SUBIR
                    </button>
                </div>
            </div>
        </section>

        <!-- Library Section -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Hairstyle List -->
            <div class="glass-panel rounded-xl flex flex-col h-[500px]">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-[#13141f]/50">
                    <h4 class="text-[#CC8E35] font-bold text-sm uppercase tracking-wide flex items-center gap-2">
                        <i class="fas fa-cut"></i> Catálogo Peinados
                    </h4>
                    <button onclick="saveBulkOrder('hairstyle')"
                        class="text-xs bg-[#CC8E35]/10 text-[#CC8E35] hover:bg-[#CC8E35] hover:text-black px-3 py-1 rounded transition border border-[#CC8E35]/20">
                        <i class="fas fa-save mr-1"></i> Guardar Orden
                    </button>
                </div>
                <div id="peinadosList" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar relative">
                    <!-- Dynamic Items -->
                </div>
            </div>

            <!-- Color List -->
            <div class="glass-panel rounded-xl flex flex-col h-[500px]">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-[#13141f]/50">
                    <h4 class="text-[#00ccff] font-bold text-sm uppercase tracking-wide flex items-center gap-2">
                        <i class="fas fa-palette"></i> Catálogo Colores
                    </h4>
                    <button onclick="saveBulkOrder('color')"
                        class="text-xs bg-[#00ccff]/10 text-[#00ccff] hover:bg-[#00ccff] hover:text-black px-3 py-1 rounded transition border border-[#00ccff]/20">
                        <i class="fas fa-save mr-1"></i> Guardar Orden
                    </button>
                </div>
                <div id="colorsList" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar relative">
                    <!-- Dynamic Items -->
                </div>
            </div>
        </section>

        <!-- Configurations (Collapsible Panels) -->
        <section class="space-y-4">
            <h3 class="text-gray-500 font-bold text-xs uppercase tracking-widest ml-1">Configuración del Sistema</h3>

            <!-- 1. Peinado Config -->
            <div class="glass-panel rounded-xl overflow-hidden">
                <div class="p-4 bg-[#1a1b26] flex justify-between items-center cursor-pointer hover:bg-[#1f202e] transition"
                    onclick="toggleSection('peinadoConfig')">
                    <div class="flex items-center gap-3">
                        <span
                            class="w-8 h-8 rounded-full bg-[#FFD700]/10 flex items-center justify-center text-[#FFD700]">
                            <i class="fas fa-microchip"></i>
                        </span>
                        <div>
                            <h4 class="text-gray-200 font-bold text-sm">Motor de Peinado (Core)</h4>
                            <p class="text-gray-600 text-[10px]">Modelos, Keys y Prompts base</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-down text-gray-600 transform transition-transform"
                        id="icon-peinadoConfig"></i>
                </div>

                <div id="peinadoConfig" class="hidden p-6 border-t border-gray-800 bg-[#13141f]">
                    <!-- Config Content -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h5 class="text-[#FFD700] text-xs font-bold mb-3">CONFIGURACIÓN API (GOOGLE)</h5>
                            <div class="space-y-3">
                                <div class="flex gap-2">
                                    <input type="text" id="googleAliasInput" placeholder="Alias (ej. Prod)"
                                        class="glass-input w-1/3 rounded px-2 text-xs">
                                    <input type="password" id="googleKeyInput" placeholder="Gemini API Key..."
                                        class="glass-input flex-1 rounded px-2 text-xs">
                                    <button onclick="saveApiKey('peinado')"
                                        class="bg-[#FFD700] text-black px-3 rounded text-xs font-bold hover:bg-yellow-400">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div id="peinadoKeysList"
                                    class="max-h-32 overflow-y-auto custom-scrollbar space-y-1 pr-1"></div>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between mb-3">
                                <h5 class="text-[#FFD700] text-xs font-bold">MODELO ACTIVO</h5>
                                <button onclick="fetchModels('peinado')"
                                    class="text-gray-500 hover:text-white text-xs"><i
                                        class="fas fa-sync-alt"></i></button>
                            </div>
                            <select id="peinadoModelSelect"
                                class="glass-input w-full rounded p-2 text-xs mb-2"></select>
                            <button onclick="saveModelSelection('peinado')"
                                class="w-full bg-[#1f202e] hover:bg-[#2a2c3d] text-gray-300 text-xs py-2 rounded transition border border-gray-700">
                                Guardar Preferencia
                            </button>
                        </div>
                    </div>

                    <div class="mt-6 pt-6 border-t border-gray-800">
                        <div class="flex justify-between items-center mb-2">
                            <h5 class="text-gray-500 text-xs font-bold">SYSTEM PROMPT (PEINADO)</h5>
                            <button onclick="unlockPrompt('hairstyle')"
                                class="text-xs text-blue-400 hover:text-blue-300"><i class="fas fa-lock mr-1"></i>
                                Editar</button>
                        </div>
                        <textarea id="hairstylePromptInput" disabled
                            class="w-full bg-[#0a0b10] text-gray-500 text-xs p-3 rounded border border-gray-800 h-24 focus:border-[#FFD700] focus:text-white transition-colors disable-enforce"></textarea>
                    </div>
                </div>
            </div>

            <!-- 2. Look Config -->
            <div class="glass-panel rounded-xl overflow-hidden">
                <div class="p-4 bg-[#1a1b26] flex justify-between items-center cursor-pointer hover:bg-[#1f202e] transition"
                    onclick="toggleSection('lookConfig')">
                    <div class="flex items-center gap-3">
                        <span
                            class="w-8 h-8 rounded-full bg-[#00ff88]/10 flex items-center justify-center text-[#00ff88]">
                            <i class="fas fa-magic"></i>
                        </span>
                        <div>
                            <h4 class="text-gray-200 font-bold text-sm">Motor de Transformación (Look)</h4>
                            <p class="text-gray-600 text-[10px]">Keys dedicadas y estructura de Prompts</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-down text-gray-600 transform transition-transform"
                        id="icon-lookConfig"></i>
                </div>

                <div id="lookConfig" class="hidden p-6 border-t border-gray-800 bg-[#13141f]">
                    <!-- Config Content -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h5 class="text-[#00ff88] text-xs font-bold mb-3">CONFIGURACIÓN API (LOOK)</h5>
                            <div class="space-y-3">
                                <div class="flex gap-2">
                                    <input type="text" id="lookAliasInput" placeholder="Alias"
                                        class="glass-input w-1/3 rounded px-2 text-xs">
                                    <input type="password" id="lookKeyInput" placeholder="Available Key..."
                                        class="glass-input flex-1 rounded px-2 text-xs">
                                    <button onclick="saveApiKey('look')"
                                        class="bg-[#00ff88] text-black px-3 rounded text-xs font-bold hover:bg-green-400">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div id="lookKeysList" class="max-h-32 overflow-y-auto custom-scrollbar space-y-1 pr-1">
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-3">
                                <h5 class="text-[#00ff88] text-xs font-bold">MODELO (LOOK)</h5>
                                <button onclick="fetchModels('look')" class="text-gray-500 hover:text-white text-xs"><i
                                        class="fas fa-sync-alt"></i></button>
                            </div>
                            <select id="lookModelSelect" class="glass-input w-full rounded p-2 text-xs mb-2"></select>
                            <button onclick="saveModelSelection('look')"
                                class="w-full bg-[#1f202e] hover:bg-[#2a2c3d] text-gray-300 text-xs py-2 rounded transition border border-gray-700">
                                Guardar Preferencia
                            </button>
                        </div>
                    </div>

                    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1 md:col-span-2 flex justify-between items-center">
                            <h5 class="text-gray-500 text-xs font-bold uppercase">Cadena de Prompts</h5>
                            <button onclick="saveLookPrompts()"
                                class="text-xs bg-[#00ff88]/10 text-[#00ff88] px-3 py-1 rounded hover:bg-[#00ff88]/20 transition"><i
                                    class="fas fa-save mr-1"></i> Guardar Todo</button>
                        </div>
                        <textarea id="lookPrompt1" placeholder="Prompt Cara (Locked)" disabled
                            class="glass-input h-24 text-[10px] p-2 rounded opacity-50 cursor-not-allowed"></textarea>
                        <textarea id="lookPrompt4" placeholder="Prompt Combo (Locked)" disabled
                            class="glass-input h-24 text-[10px] p-2 rounded opacity-50 cursor-not-allowed"></textarea>
                        <textarea id="lookPrompt2" placeholder="Prompt Dinámico Peinados"
                            class="glass-input h-24 text-[10px] p-2 rounded border-l-2 border-l-[#00ff88]"></textarea>
                        <textarea id="lookPrompt3" placeholder="Prompt Dinámico Colores"
                            class="glass-input h-24 text-[10px] p-2 rounded border-l-2 border-l-[#00ff88]"></textarea>
                    </div>
                </div>
            </div>
            <!-- 3. Asesoria Config -->
            <div class="glass-panel rounded-xl overflow-hidden">
                <div class="p-4 bg-[#1a1b26] flex justify-between items-center cursor-pointer hover:bg-[#1f202e] transition"
                    onclick="toggleSection('asesoriaConfig')">
                    <div class="flex items-center gap-3">
                        <span
                            class="w-8 h-8 rounded-full bg-[#00ccff]/10 flex items-center justify-center text-[#00ccff]">
                            <i class="fas fa-robot"></i>
                        </span>
                        <div>
                            <h4 class="text-gray-200 font-bold text-sm">Motor de Asesoría (Chat)</h4>
                            <p class="text-gray-600 text-[10px]">Personality & Chatbot Keys</p>
                        </div>
                    </div>
                    <i class="fas fa-chevron-down text-gray-600 transform transition-transform"
                        id="icon-asesoriaConfig"></i>
                </div>

                <div id="asesoriaConfig" class="hidden p-6 border-t border-gray-800 bg-[#13141f]">
                    <!-- Config Content -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h5 class="text-[#00ccff] text-xs font-bold mb-3">CONFIGURACIÓN API (CHAT)</h5>
                            <div class="space-y-3">
                                <div class="flex gap-2">
                                    <input type="text" id="asesoriaAliasInput" placeholder="Alias"
                                        class="glass-input w-1/3 rounded px-2 text-xs">
                                    <input type="password" id="asesoriaKeyInput" placeholder="Chat Key..."
                                        class="glass-input flex-1 rounded px-2 text-xs">
                                    <button onclick="saveApiKey('asesoria')"
                                        class="bg-[#00ccff] text-black px-3 rounded text-xs font-bold hover:bg-cyan-400">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div id="asesoriaKeysList"
                                    class="max-h-32 overflow-y-auto custom-scrollbar space-y-1 pr-1"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-3">
                                <h5 class="text-[#00ccff] text-xs font-bold">MODELO (CHAT)</h5>
                                <button onclick="fetchModels('asesoria')"
                                    class="text-gray-500 hover:text-white text-xs"><i
                                        class="fas fa-sync-alt"></i></button>
                            </div>
                            <select id="asesoriaModelSelect"
                                class="glass-input w-full rounded p-2 text-xs mb-2"></select>
                            <button onclick="saveModelSelection('asesoria')"
                                class="w-full bg-[#1f202e] hover:bg-[#2a2c3d] text-gray-300 text-xs py-2 rounded transition border border-gray-700">
                                Guardar Preferencia
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </section>

    </main>

    <!-- Global Password Modal -->
    <div id="passwordModal"
        class="hidden fixed inset-0 bg-black/95 flex justify-center items-center z-[2000] backdrop-blur-sm transition-opacity">
        <div class="glass-panel p-8 rounded-2xl w-80 shadow-2xl border border-gray-800">
            <div class="text-center mb-6">
                <i class="fas fa-shield-alt text-4xl text-[#FFD700] mb-4"></i>
                <h3 class="text-lg font-bold">Autenticación Requerida</h3>
                <p class="text-xs text-gray-400 mt-2" id="modalDesc">Acción protegida</p>
            </div>

            <input type="password" id="modalPassword" placeholder="PIN de Seguridad"
                class="w-full bg-[#0a0b10] border border-gray-700 rounded-lg p-3 text-center text-xl tracking-[0.5em] focus:border-[#FFD700] outline-none text-white mb-6">

            <div class="flex gap-3">
                <button onclick="closeModal()"
                    class="flex-1 py-2 rounded text-xs hover:bg-white/10 text-gray-400">Cancelar</button>
                <button onclick="submitModal()"
                    class="flex-1 bg-[#FFD700] hover:bg-[#e6c200] text-black font-bold py-2 rounded text-xs shadow-lg shadow-yellow-900/20">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed bottom-6 right-6 transform translate-y-32 opacity-0 transition-all duration-500 z-[3000]">
        <div class="glass-panel border-l-4 border-[#00ff88] px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4">
            <i class="fas fa-check-circle text-[#00ff88] text-xl" id="toastIcon"></i>
            <div>
                <h4 class="font-bold text-sm text-white" id="toastTitle">Notificación</h4>
                <p class="text-xs text-gray-400" id="toastMsg">...</p>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // Core Logic
        const API_BASE = '/api/mirror';
        let pendingAction = null;
        let pendingPayload = null;

        document.addEventListener('DOMContentLoaded', () => {
            initDashboard();
        });

        async function initDashboard() {
            await Promise.all([
                fetchStats(),
                fetchAdminItems(),
                loadConfig('peinado'),
                loadConfig('look'),
                loadConfig('asesoria'),
                fetchSystemPrompts()
            ]);
        }

        function toggleSection(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            el.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        }

        // --- Stats & Items ---
        async function fetchStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`);
                const data = await res.json();
                document.getElementById('statsCount').innerText = data.generations || 0;
                document.getElementById('totalTokensCount').innerText = `${(data.total_tokens || 0).toLocaleString()} Tokens`;
            } catch (e) { console.error(e); }
        }

        async function uploadItem() {
            const btn = document.getElementById('uploadBtn');
            const fileInput = document.getElementById('newItemFile');
            const nameInput = document.getElementById('newItemName');
            const catSelect = document.getElementById('newItemCategory');
            const colorInput = document.getElementById('newItemColorCode');

            if (!fileInput.files[0] || !nameInput.value) return showToast('Faltan datos', 'error');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            const formData = new FormData();
            formData.append('name', nameInput.value);
            formData.append('category', catSelect.value);
            formData.append('file', fileInput.files[0]);
            if (catSelect.value === 'color') formData.append('color_code', colorInput.value);

            try {
                const res = await fetch(`${API_BASE}/items`, { method: 'POST', body: formData });
                if (res.ok) {
                    showToast('Item subido correctamente');
                    nameInput.value = '';
                    fileInput.value = '';
                    document.getElementById('fileLabel').innerHTML = '<i class="fas fa-image mr-1"></i> Seleccionar Imagen';
                    fetchAdminItems();
                } else throw new Error();
            } catch (e) { showToast('Error al subir item', 'error'); }

            btn.disabled = false;
            btn.innerText = 'SUBIR';
        }

        async function fetchAdminItems() {
            const res = await fetch(`${API_BASE}/items?t=${Date.now()}`);
            const items = await res.json();

            renderList('peinadosList', items.filter(i => i.category === 'hairstyle'));
            renderList('colorsList', items.filter(i => i.category === 'color'));
        }

        function renderList(containerId, items) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            items.sort((a, b) => a.order_index - b.order_index).forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-[#13141f] p-2 rounded border border-gray-800 hover:border-gray-600 group';
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 flex items-center justify-center bg-gray-800 rounded font-mono text-xs text-gray-500 font-bold handle cursor-grab hover:text-white hover:bg-gray-700">
                             ${item.order_index}
                        </div>
                        <div class="w-10 h-10 rounded bg-gray-800 bg-cover bg-center" style="background-image: url('${item.image_url}')"></div>
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-gray-300">${item.name}</span>
                            <span class="text-[10px] text-gray-600 truncate max-w-[150px]">${item.prompt || 'Auto-prompt pending...'}</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-1 opacity-50 group-hover:opacity-100 transition">
                         <input type="number" value="${item.order_index}" data-id="${item.id}" class="order-input w-8 bg-transparent text-right text-xs text-gray-500 focus:text-white outline-none">
                         <button onclick="requestDelete(${item.id})" class="text-red-900 hover:text-red-500 p-2 rounded"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function saveBulkOrder(category) {
            const containerId = category === 'hairstyle' ? 'peinadosList' : 'colorsList';
            const inputs = document.getElementById(containerId).querySelectorAll('.order-input');
            const updates = Array.from(inputs).map(inp => ({
                id: inp.dataset.id,
                order_index: parseInt(inp.value) || 0
            }));

            const res = await fetch(`${API_BASE}/items/reorder`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            });
            if (res.ok) showToast('Orden actualizado');
            else showToast('Error actualizando orden', 'error');
            fetchAdminItems(); // Refresh to sort
        }


        // --- Config Engine (Generic) ---

        async function loadConfig(section) {
            // 1. Fetch Keys
            await fetchKeys(section);
            // 2. Fetch Models
            await fetchModels(section);
        }

        async function fetchKeys(section) {
            try {
                const res = await fetch(`${API_BASE}/keys?section=${section}`);
                const keys = await res.json();
                // FIX: Check if keys is array
                const validKeys = Array.isArray(keys) ? keys : [];

                const listId = section === 'peinado' ? 'peinadoKeysList' : `${section}KeysList`;
                const container = document.getElementById(listId);
                container.innerHTML = '';

                validKeys.filter(k => k.provider === 'google').forEach(k => {
                    const el = document.createElement('div');
                    el.className = `flex justify-between items-center p-2 rounded text-xs border ${k.is_active ? 'border-green-500/20 bg-green-500/5' : 'border-gray-800 bg-gray-900'}`;
                    el.innerHTML = `
                         <span class="${k.is_active ? 'text-green-400 font-bold' : 'text-gray-500'}">${k.alias}</span>
                         <div class="flex gap-2">
                            ${!k.is_active ? `<button onclick="activateKey(${k.id}, '${section}')" class="text-gray-600 hover:text-green-400"><i class="fas fa-play"></i></button>` : '<i class="fas fa-circle text-[8px] text-green-500 animate-pulse mt-1"></i>'}
                            <button onclick="deleteKey(${k.id}, '${section}')" class="text-gray-700 hover:text-red-400"><i class="fas fa-times"></i></button>
                         </div>
                    `;
                    container.appendChild(el);
                });
            } catch (e) { console.error("Key Load Error", e); }
        }

        async function fetchModels(section) {
            const selectId = section === 'peinado' ? 'peinadoModelSelect' : `${section}ModelSelect`;
            const select = document.getElementById(selectId);
            select.innerHTML = '<option>Cargando...</option>';

            try {
                // Parallel fetch: Available models AND Active Key preference
                const [modelsRes, keysRes] = await Promise.all([
                    fetch(`${API_BASE}/models?section=${section}`),
                    fetch(`${API_BASE}/keys?section=${section}`)
                ]);

                const models = await modelsRes.json();
                const keys = await keysRes.json();
                // FIX: Check isArray logic
                const safeKeys = Array.isArray(keys) ? keys : [];
                const activeKey = safeKeys.find(k => k.provider === 'google' && k.is_active);
                const currentModel = activeKey?.settings?.model;

                select.innerHTML = '';

                if (Array.isArray(models) && models.length > 0) {
                    models.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.name;
                        opt.text = m.displayName;
                        if (m.name === currentModel) opt.selected = true;
                        select.appendChild(opt);
                    });
                } else {
                    select.innerHTML = '<option value="">Sin modelos disponibles</option>';
                }

            } catch (e) {
                console.error(e);
                select.innerHTML = '<option>Error de conexión</option>';
            }
        }

        async function saveApiKey(section) {
            const prefix = section === 'peinado' ? 'google' : section;
            const alias = document.getElementById(`${prefix}AliasInput`).value;
            const key = document.getElementById(`${prefix}KeyInput`).value;

            if (!alias || !key) return showToast('Completa los campos', 'warning');

            await fetch(`${API_BASE}/keys`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    provider: 'google',
                    alias,
                    api_key: key,
                    section: section
                })
            });

            document.getElementById(`${prefix}KeyInput`).value = '';
            showToast('Llave guardada');
            fetchKeys(section);
        }

        async function activateKey(id, section) {
            await fetch(`${API_BASE}/keys/${id}/active`, { method: 'PUT' });
            showToast('Llave activada');
            fetchKeys(section);
            setTimeout(() => fetchModels(section), 500);
        }

        async function deleteKey(id, section) {
            if (confirm("¿Eliminar llave?")) {
                await fetch(`${API_BASE}/keys/${id}`, { method: 'DELETE' });
                fetchKeys(section);
            }
        }

        async function saveModelSelection(section) {
            const select = document.getElementById(section === 'peinado' ? 'peinadoModelSelect' : `${section}ModelSelect`);
            const model = select.value;
            if (!model) return;

            // We need the active key ID relative to this section to update its settings
            const keysRes = await fetch(`${API_BASE}/keys?section=${section}`);
            const keys = await keysRes.json();
            const safeKeys = Array.isArray(keys) ? keys : [];
            const activeKey = safeKeys.find(k => k.is_active);

            if (activeKey) {
                const res = await fetch(`${API_BASE}/keys/${activeKey.id}/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model })
                });
                if (res.ok) showToast(`Modelo actualizado a ${model}`);
            } else {
                showToast('No hay llave activa en esta sección', 'error');
            }
        }

        // --- Prompt Editing ---

        async function fetchSystemPrompts() {
            try {
                const res = await fetch(`${API_BASE}/config`);
                const config = await res.json();

                document.getElementById('hairstylePromptInput').value = config.hairstyle_sys_prompt || '';
                document.getElementById('lookPrompt1').value = config.look_sys_prompt_1 || '';
                document.getElementById('lookPrompt2').value = config.look_sys_prompt_2 || '';
                document.getElementById('lookPrompt3').value = config.look_sys_prompt_3 || '';
                document.getElementById('lookPrompt4').value = config.look_sys_prompt_4 || '';

            } catch (e) { console.error(e); }
        }

        async function saveLookPrompts() {
            const payload = {
                look_sys_prompt_1: document.getElementById('lookPrompt1').value,
                look_sys_prompt_2: document.getElementById('lookPrompt2').value,
                look_sys_prompt_3: document.getElementById('lookPrompt3').value,
                look_sys_prompt_4: document.getElementById('lookPrompt4').value
            };
            await updateConfig(payload);
            showToast('Estructura Look Guardada');
        }

        async function unlockPrompt(target) {
            pendingAction = 'unlock';
            pendingPayload = target;
            document.getElementById('passwordModal').classList.remove('hidden');
        }

        async function updateConfig(data) {
            await fetch(`${API_BASE}/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }


        // --- UI Utils ---
        function updateFileLabel(inp) {
            if (inp.files.length) document.getElementById('fileLabel').innerText = inp.files[0].name;
        }

        function toggleColorInput() {
            const val = document.getElementById('newItemCategory').value;
            const col = document.getElementById('newItemColorCode');
            if (val === 'color') col.classList.remove('hidden');
            else col.classList.add('hidden');
        }

        function requestDelete(id) {
            pendingAction = 'deleteItem';
            pendingPayload = id;
            document.getElementById('passwordModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('modalPassword').value = '';
            pendingAction = null;
        }

        async function submitModal() {
            const pass = document.getElementById('modalPassword').value;
            if (pass !== '1234') { // Hardcoded for simplicity as per legacy
                showToast('PIN Incorrecto', 'error');
                return;
            }

            closeModal();

            if (pendingAction === 'deleteItem') {
                await fetch(`${API_BASE}/items/${pendingPayload}`, { method: 'DELETE' });
                showToast('Eliminado');
                fetchAdminItems();
            } else if (pendingAction === 'unlock') {
                if (pendingPayload === 'hairstyle') {
                    const el = document.getElementById('hairstylePromptInput');
                    el.disabled = false;
                    el.classList.add('border-[#FFD700]', 'text-gray-200');
                    el.focus();

                    // Add save button dynamically if not exists, or just auto-save on blur? 
                    // Let's make the user hit enter or add a save btn.
                    // Simple approach: Add listener to save on change
                    el.addEventListener('change', async () => {
                        await updateConfig({ hairstyle_sys_prompt: el.value });
                        showToast('Prompt Core Actualizado');
                    });
                    showToast('Edición Habilitada (Auto-guardado al salir)');
                }
            }
        }

        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            const tit = document.getElementById('toastTitle');
            const m = document.getElementById('toastMsg');
            const ico = document.getElementById('toastIcon');

            tit.innerText = type === 'success' ? 'Éxito' : 'Atención';
            m.innerText = msg;

            if (type === 'error') {
                t.firstElementChild.className = 'glass-panel border-l-4 border-red-500 px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4';
                ico.className = 'fas fa-exclamation-circle text-red-500 text-xl';
            } else {
                t.firstElementChild.className = 'glass-panel border-l-4 border-[#00ff88] px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4';
                ico.className = 'fas fa-check-circle text-[#00ff88] text-xl';
            }

            t.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000);
        }

    </script>
</body>

</html>